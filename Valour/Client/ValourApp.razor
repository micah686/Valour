@inject ValourClient Client
@inject LoggingService Logger
@inject IJSRuntime JsRuntime
@inject IAppStorage LocalStorage
@inject SoundManager SoundManager

<BrowserUtils OnReady="@ReadyAsync" />

<UpdateBanner />

<!-- Enable app sounds -->
<SoundsComponent @key="@("sounds-component")"></SoundsComponent>

<!-- Enable event listeners -->
<KeyboardListener />
<MouseListener />

<!-- Enable themes -->
<ThemeComponent />

<!-- Window Target helper -->
<WindowTargetScanner />

<TooltipRoot />
<GlobalRealtimeKitHostComponent />

@if (_triedInitialLogin)
{
    <!-- Main routing component -->
    <Router AppAssembly="@typeof(Valour.Client.Pages.Index).Assembly">
        <Found Context="routeData">
            <RouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)" />
        </Found>
        <NotFound>
            <LayoutView Layout="@typeof(MainLayout)">
                <p>Sorry, there's nothing at this address.</p>
            </LayoutView>
        </NotFound>
    </Router>
}
else
{
    <Loading Subtext='Logging you in...'></Loading>
}

@code{
    const bool USE_PROD = false;

    private bool _triedInitialLogin;
    private bool _needsErrorReportingCheck;
    private bool _browserReady;
    private bool _firstRenderReady;
    private bool _startupInitializationStarted;

    protected override async Task OnInitializedAsync()
    {
        Logger.AddColorLogger(Log);
        await DevicePreferences.LoadPreferences(LocalStorage);
        Logger.Log("App", "Loaded user preferences", "magenta");
    }

    // Runs when page is initialized
    private async Task ReadyAsync()
    {
        var uriData = await BrowserUtils.GetUriData();
        Logger.Log("App", $"Origin is {uriData.Origin}", "magenta");

        var hostMode = "web";
        try
        {
            hostMode = await JsRuntime.InvokeAsync<string>("getValourHostMode");
        }
        catch
        {
            // Host page does not expose a host mode marker.
        }

        var isLocalWebViewOrigin =
            string.Equals(uriData.Hostname, "0.0.0.1", StringComparison.OrdinalIgnoreCase) ||
            string.Equals(uriData.Hostname, "0.0.0.0", StringComparison.OrdinalIgnoreCase) ||
            string.Equals(uriData.Hostname, "127.0.0.1", StringComparison.OrdinalIgnoreCase) ||
            string.Equals(uriData.Hostname, "localhost", StringComparison.OrdinalIgnoreCase);

        if (hostMode != "hybrid" && !isLocalWebViewOrigin)
        {
            if (!USE_PROD)
            {
                var apiOrigin = uriData.Origin;
                try
                {
                    var configuredApiOrigin = await JsRuntime.InvokeAsync<string>("getValourApiOrigin");
                    if (!string.IsNullOrWhiteSpace(configuredApiOrigin))
                        apiOrigin = configuredApiOrigin;
                }
                catch
                {
                    // Host page does not expose an API origin override.
                }

                // Set the origin for the client
                // We do this here because while the value is assumed in startup
                // we have access to the JS runtime to get the actual value
                Logger.Log("App", $"API origin is {apiOrigin}", "magenta");
                Client.SetOrigin(apiOrigin);
            }
            else
            {
                Client.SetOrigin("https://app.valour.gg/");
            }
        }
        else
        {
            Logger.Log("App", $"Using native/default API origin (hostMode={hostMode}, hostname={uriData.Hostname})", "magenta");
        }

        _ = JsRuntime.InvokeAsync<object>(
            "blazorFuncs.registerClient",
            DotNetObjectReference.Create(this)
        );

        _browserReady = true;
        await TryCompleteStartupInitializationAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var isMobile = await JsRuntime.InvokeAsync<bool>("IsMobile");
            var isEmbedded = await JsRuntime.InvokeAsync<bool>("IsEmbedded");

            DeviceInfo.IsMobile = isMobile;
            DeviceInfo.IsEmbedded = isEmbedded;
            _firstRenderReady = true;
            await TryCompleteStartupInitializationAsync();
        }
        else if (_needsErrorReportingCheck)
        {
            _needsErrorReportingCheck = false;
            await CheckErrorReportingPreference();
        }
    }

    private async Task TryCompleteStartupInitializationAsync()
    {
        if (!_browserReady || !_firstRenderReady || _startupInitializationStarted)
            return;

        _startupInitializationStarted = true;

        if (!Client.IsLoggedIn)
        {
            var localToken = await LocalStorage.GetStringAsync("token");

            if (!string.IsNullOrWhiteSpace(localToken))
            {
                var result = await Client.InitializeUser(localToken);

                if (result.Code == 401)
                {
                    // Clear cookie
                    await LocalStorage.RemoveAsync("token");
                }

                if (result.Success)
                {
                    Log("App", $"Auto-logged user {Client.Me.Name}", "magenta");
                    _needsErrorReportingCheck = true;
                }
            }
        }

        // Ensure PrimaryNode is set up for anonymous API calls (e.g., invite pages)
        if (Client.PrimaryNode is null)
        {
            await Client.NodeService.SetupPrimaryNodeAsync();
        }

        _triedInitialLogin = true;
        Log("App", $"Tried initial login. Status: {Client.IsLoggedIn}", "magenta");

        await InvokeAsync(StateHasChanged);
    }

    private async Task CheckErrorReportingPreference()
    {
        try
        {
            var response = await Client.PrimaryNode.GetJsonAsync<UserPreferences>("api/users/me/preferences");
            if (!response.Success || response.Data is null)
                return;

            var prefs = response.Data;
            SoundManager.SetNotificationVolume(prefs.NotificationVolume);

            if (prefs.ErrorReportingState == ErrorReportingState.All)
            {
                await DevicePreferences.SetErrorReportingEnabled(true, LocalStorage);
                return;
            }

            if (prefs.ErrorReportingState == ErrorReportingState.None)
            {
                await DevicePreferences.SetErrorReportingEnabled(false, LocalStorage);
                return;
            }

            // State is Unset â€” prompt the user
            var modalData = new ConfirmModalComponent.ModalParams(
                "Help Improve Valour",
                "Would you like to share anonymous error reports to help us find and fix bugs?",
                "Yes",
                "No",
                async () =>
                {
                    await Client.PrimaryNode.PostAsync($"api/users/me/preferences/errorReporting/{(int)ErrorReportingState.All}", null);
                    await DevicePreferences.SetErrorReportingEnabled(true, LocalStorage);
                },
                async () =>
                {
                    await Client.PrimaryNode.PostAsync($"api/users/me/preferences/errorReporting/{(int)ErrorReportingState.None}", null);
                    await DevicePreferences.SetErrorReportingEnabled(false, LocalStorage);
                }
            );

            ModalRoot.Instance.OpenModal<ConfirmModalComponent>(modalData);
        }
        catch
        {
            // Don't block login on preference fetch failure
        }
    }

    public void Log(string prefix, string msg, string color)
    {
        _ = JsRuntime.InvokeVoidAsync("Log", $"[{prefix}] {msg}", color);
    }

    /* TODO: Fix push subscriptions
    [JSInvokable("NotifyPushSub")]
    public static async Task NotifyPushSub(string endpoint, string key, string auth)
    {
        Sdk.Models.NotificationSubscription not = new()
        {
            Endpoint = endpoint,
            Auth = auth,
            Key = key,
            UserId = Client.Self.Id
        };

        // Send subscription information to server
        var response = await Client.PrimaryNode.PostAsyncWithResponse<TaskResult>($"Notification/SubmitSubscription", not);
        Console.WriteLine(response.Message);
    }
    */
}
