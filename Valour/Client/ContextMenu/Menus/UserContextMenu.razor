@inherits ContextMenu<UserContextMenu.UserContextParams>
@inject IJSRuntime JsRuntime
@inject ValourClient Client
@inject FriendService FriendService
@inject BlockService BlockService
@inject ChannelService ChannelService

<ContextMenuItem OnClickAsync="@OnClickMessage">
	<Label>Message</Label>
	<Icon><i class="bi bi-chat-dots-fill"></i></Icon>
</ContextMenuItem>
@if (_isFriend)
{
	<ContextMenuItem OnClickAsync="@OnClickRemoveFriend">
		<Label>Remove Friend</Label>
		<Icon>-<i class="bi bi-person-fill"></i></Icon>
	</ContextMenuItem>
}
else if (_isFriendRequested)
{
	<ContextMenuItem OnClickAsync="@OnClickRemoveFriend">
		Cancel Request
	</ContextMenuItem>
}
else
{
	<ContextMenuItem OnClickAsync="@OnClickAddFriend">
		<Label>
			Add Friend
		</Label>
		<Icon>+<i class="bi bi-person-fill"></i></Icon>
	</ContextMenuItem>
}

@if (!_isSelf && _isBlocked)
{
	<ContextMenuItem OnClickAsync="@OnClickUnblock">
		<Label>Unblock</Label>
		<Icon><i class="bi bi-shield-fill-check"></i></Icon>
	</ContextMenuItem>
}
else if (!_isSelf)
{
	<ContextSubMenu>
		<Label>Block</Label>
		<Icon><i class="bi bi-shield-fill-x"></i></Icon>
		<Content>
			<ContextMenuItem OnClickAsync="@(() => OnClickBlock(BlockType.OneWay))">One-Way Block</ContextMenuItem>
			<ContextMenuItem OnClickAsync="@(() => OnClickBlock(BlockType.TwoWay))">Two-Way Block</ContextMenuItem>
		</Content>
	</ContextSubMenu>
}

<ContextSubMenu>
	<Label>Copy</Label>
	<Icon><i class="bi bi-caret-right-fill"></i></Icon>
	<Content>
		<ContextMenuItem OnClickAsync="@OnClickCopyUsername">Username</ContextMenuItem>
		<ContextMenuItem OnClickAsync="@OnClickCopyUserId">User Id</ContextMenuItem>
	</Content>
</ContextSubMenu>

@code {

	public class UserContextParams
	{
		public User User;
	}

	protected override void OnInitialized()
	{
		_isFriendRequested = FriendService.OutgoingRequests.Any(x => x.Id == Data.User.Id);
		_isFriend = FriendService.Friends.Any(x => x.Id == Data.User.Id);
		_isSelf = Data.User.Id == Client.Me.Id;
		_isBlocked = BlockService.IsBlocked(Data.User.Id);
	}

	private bool _isFriend;
	private bool _isFriendRequested;
	private bool _isSelf;
	private bool _isBlocked;

	private async Task OnClickAddFriend()
	{
		var result = await FriendService.AddFriendAsync(Data.User.NameAndTag);

		if (!result.Success)
		{
			Client.Logger.Log<UserContextMenu>($"Failed to add friend:\n{result.Message}", "orange");
			return;
		}

		_isFriend = true;
		StateHasChanged();
	}

	private async Task OnClickRemoveFriend()
	{
		var result = await FriendService.RemoveFriendAsync(Data.User.NameAndTag);

		if (!result.Success)
		{
			Client.Logger.Log<UserContextMenu>($"Failed to remove friend:\n{result.Message}", "orange");
			return;
		}

		_isFriendRequested = false;
		_isFriend = false;
		StateHasChanged();
	}

	    private async Task OnClickCopyUsername(){
        await JsRuntime.InvokeVoidAsync("clipboardCopy.copyText", Data.User.NameAndTag);
        ToastContainer.Instance.AddToast(new ToastData("Copied!", "Username copied to clipboard", ToastProgressState.Success));
    }

    private async Task OnClickCopyUserId(){
        await JsRuntime.InvokeVoidAsync("clipboardCopy.copyText", Data.User.Id);
        ToastContainer.Instance.AddToast(new ToastData("Copied!", "User ID copied to clipboard", ToastProgressState.Success));
    }
	
	private async Task OnClickMessage()
	{
		var channel = await ChannelService.FetchDmChannelAsync(Data.User.Id, true);
		var newWindowContent = await ChatWindowComponent.GetDefaultContent(channel);
		await WindowService.OpenWindowAtFocused(newWindowContent);
	}

	private async Task OnClickBlock(BlockType blockType)
	{
		var result = await BlockService.BlockUserAsync(Data.User.Id, blockType);
		if (result.Success)
			ToastContainer.Instance.AddToast(new ToastData("Blocked", $"{Data.User.Name} has been blocked.", ToastProgressState.Success));
		else
			ToastContainer.Instance.AddToast(new ToastData("Error", result.Message, ToastProgressState.Failure));

		await CloseAsync();
	}

	private async Task OnClickUnblock()
	{
		var result = await BlockService.UnblockUserAsync(Data.User.Id);
		if (result.Success)
			ToastContainer.Instance.AddToast(new ToastData("Unblocked", $"{Data.User.Name} has been unblocked.", ToastProgressState.Success));
		else
			ToastContainer.Instance.AddToast(new ToastData("Error", result.Message, ToastProgressState.Failure));

		await CloseAsync();
	}
}