@using Valour.Shared.Models.Themes
@inject IAppStorage LocalStorage

<div id="theme">
    <style>
        :root {
            --font-color: @CurrentTheme.FontColor;
            --font-alt-color: @CurrentTheme.FontAltColor;
            --link-color: @CurrentTheme.LinkColor;
            
            --main-1: @CurrentTheme.MainColor1;
            --main-2: @CurrentTheme.MainColor2;
            --main-3: @CurrentTheme.MainColor3;
            --main-4: @CurrentTheme.MainColor4;
            --main-5: @CurrentTheme.MainColor5;
            
            --modal-main: @(CurrentTheme.MainColor1 + "55");
            --modal-medium: @(CurrentTheme.MainColor1 + "aa");
            --modal-dark: @(CurrentTheme.MainColor1 + "cc");
            
            --slight-tint: @(CurrentTheme.TintColor + "15");
            --medium-tint: @(CurrentTheme.TintColor + "30");
            --strong-tint: @(CurrentTheme.TintColor + "55");
            
            /* Vibrant colors */
            --v-purple: @CurrentTheme.VibrantPurple;
            --v-blue:   @CurrentTheme.VibrantBlue;
            --v-cyan:   @CurrentTheme.VibrantCyan;
        
            /* Pastel colors */
            --p-cyan:        @CurrentTheme.PastelCyan;
            --p-cyan-purple: @CurrentTheme.PastelCyanPurple;
            --p-purple:      @CurrentTheme.PastelPurple;
            --p-red:         @CurrentTheme.PastelRed;

            /* Theme asset variables */
            @foreach (var asset in CurrentTheme.Assets ?? Enumerable.Empty<ThemeAssetInfo>())
            {
                @if (asset.AssetType != "font")
                {
                    <text>--theme-asset-@asset.Name: url(@asset.Url);</text>
                }
            }
        }

        /* Theme font assets */
        @foreach (var asset in CurrentTheme.Assets ?? Enumerable.Empty<ThemeAssetInfo>())
        {
            @if (asset.AssetType == "font")
            {
                <text>
                @@font-face {
                    font-family: "theme-font-@asset.Name";
                    src: url("@asset.Url") format("@GetFontFormat(asset.Url)");
                }
                </text>
            }
        }

        /* Custom CSS */
        @GetSanitizedCustomCss()
    </style>
</div>

@code {
    public static ThemeComponent Instance;
    
    [Parameter]
    public Theme CurrentTheme { get; set; } = Theme.Default;
    public static event Action OnThemeChanged;
    
    public async Task InstallTheme(Theme theme)
    {
        CurrentTheme = theme;
        await LocalStorage.SetStringAsync("ACTIVE_THEME", JsonSerializer.Serialize(CurrentTheme));
        StateHasChanged();
        OnThemeChanged?.Invoke();
    }
    public async Task UninstallThemeAsync()
    {
        CurrentTheme = Theme.Default;
        if (await LocalStorage.ContainsKeyAsync("ACTIVE_THEME"))
            await LocalStorage.RemoveAsync("ACTIVE_THEME");
        StateHasChanged();
        OnThemeChanged?.Invoke();
    }

    private static string GetFontFormat(string url)
    {
        if (string.IsNullOrEmpty(url))
            return "woff2";

        var ext = url.Split('.').LastOrDefault()?.ToLowerInvariant();
        return ext switch
        {
            "woff2" => "woff2",
            "woff" => "woff",
            "ttf" => "truetype",
            "otf" => "opentype",
            _ => "woff2",
        };
    }

    private string GetSanitizedCustomCss()
    {
        if (string.IsNullOrWhiteSpace(CurrentTheme.CustomCss))
            return string.Empty;

        try
        {
            var css = CurrentTheme.CustomCss;

            // Defense-in-depth: block dangerous patterns on client too
            if (css.Contains('[') || css.Contains(']'))
                return string.Empty;

            var cssLower = css.ToLowerInvariant();
            if (cssLower.Contains("url(") || cssLower.Contains("@import") ||
                cssLower.Contains("@font-face") || cssLower.Contains("javascript:") ||
                cssLower.Contains("expression(") || cssLower.Contains("behavior:") ||
                cssLower.Contains("-moz-binding") || cssLower.Contains("</style"))
                return string.Empty;

            return css; // Return original CSS, preserving comments/formatting
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
            return string.Empty;
        }
    }
    
    private bool AreBracketsValid(string input)
    {
        int count = 0;

        foreach (char c in input)
        {
            if (c == '{')
            {
                count++;
            }
            else if (c == '}')
            {
                count--;
                if (count < 0)
                {
                    return false; // More closing brackets than opening brackets
                }
            }
        }

        return count == 0; // True if opening and closing brackets match
    }
    
    protected override async Task OnInitializedAsync()
    {
        Instance = this;
        
        // Load from local storage
        if (await LocalStorage.ContainsKeyAsync("ACTIVE_THEME"))
        {
            CurrentTheme = JsonSerializer.Deserialize<Theme>(await LocalStorage.GetStringAsync("ACTIVE_THEME"));
            StateHasChanged();
        }
    }
    
   

    public void Refresh()
    {
        StateHasChanged();
    }
}