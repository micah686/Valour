@inject IJSRuntime JsRuntime
@inject NavigationManager NavManager
@inject ValourClient Client

@if (_page == SubPage.Redirecting)
{
    <h4 class="title">Subscriptions</h4>
    <h5 class="subtitle">@_redirectingMessage</h5>

    <div class="redirecting-container mt-4">
        <h3 style="color: var(--v-purple);">Redirecting to checkout...</h3>
        <p>@_redirectingDetail</p>

        @if (!string.IsNullOrWhiteSpace(_errorSpan))
        {
            <span class="v-text-red mt-4">@_errorSpan</span>
        }

        <button class="v-btn mt-4" @onclick="BackToMain">Go back</button>
    </div>
}
else if (_page == SubPage.StripeResult)
{
    <h4 class="title">Subscriptions</h4>

    <div class="result-container mt-4">
        <h3 style="color: var(--v-purple);">@_stripeResultTitle</h3>
        <br />
        <p>@_stripeResultMessage</p>

        <button class="v-btn mt-4" @onclick="BackToMain">Back to Subscriptions</button>
    </div>
}
else
{
    <h4 class="title">Subscriptions</h4>
    <h5 class="subtitle">Support Valour and unlock perks</h5>

    @* Active Subscription Banner *@
    @if (_activeSub is not null)
    {
        <div class="active-banner @GetBannerStatusClass()">
            <div class="banner-content">
                <div class="banner-info">
                    <div class="banner-header">
                        <span class="banner-tier-name">@_activeSub.Type</span>
                        <span class="status-badge @GetBadgeClass()">@GetStatusText()</span>
                    </div>
                    <span class="banner-billing">@GetBillingText()</span>
                    @if (_activeSub.StripePaymentFailed)
                    {
                        <span class="banner-warning">Your last payment failed. Please update your payment method.</span>
                    }
                    @if (_activeSub.Cancelled && _activeSub.StripeSubscriptionId is not null)
                    {
                        <span class="banner-note">Active until end of billing period</span>
                    }
                    @if (_activeSub.PendingType is not null)
                    {
                        <span class="banner-note">Changing to @_activeSub.PendingType next billing cycle</span>
                    }
                </div>
                <div class="banner-actions">
                    @if (_activeSub.PendingType is not null)
                    {
                        <button class="v-btn" @onclick="OnClickCancelPending">Undo Downgrade</button>
                    }
                    @if (_activeSub.Cancelled && _activeSub.StripeSubscriptionId is null)
                    {
                        <button class="v-btn primary" @onclick="OnClickReactivate">Re-activate</button>
                    }
                    else if (!_activeSub.Cancelled)
                    {
                        @if (!_confirmingCancel)
                        {
                            <button class="v-btn danger" @onclick="() => { _confirmingCancel = true; StateHasChanged(); }">Cancel Subscription</button>
                        }
                        else
                        {
                            <span class="cancel-confirm-text">Are you sure?</span>
                            <div class="cancel-confirm-buttons">
                                <button class="v-btn danger" @onclick="OnConfirmCancel">Yes, Cancel</button>
                                <button class="v-btn" @onclick="() => { _confirmingCancel = false; StateHasChanged(); }">Keep It</button>
                            </div>
                        }
                    }
                </div>
            </div>
            @if (!string.IsNullOrWhiteSpace(_errorSpan) && _selectedTier is null)
            {
                <span class="v-text-red mt-2" style="display: block; padding: 0 1rem 1rem;">@_errorSpan</span>
            }
        </div>
    }

    @* Subscription Tiers *@
    <div class="editor-section">
        <div class="editor-section-title">
            <i class="bi bi-star-fill"></i>
            SUBSCRIPTION TIERS
        </div>

        <div class="tier-grid">
            @foreach (var tier in _allTiers)
            {
                var isActive = _activeSub is not null && _activeSub.Type == tier.Name && !_activeSub.Cancelled;
                var isPending = _activeSub is not null && _activeSub.PendingType == tier.Name;
                var isExpanded = _selectedTier == tier;
                var tierAction = GetTierAction(tier);

                <div class="tier-card @(isActive ? "active" : "") @(isPending ? "pending" : "") @(isExpanded ? "expanded" : "")">
                    <img alt="@tier.Name logo" class="tier-img" src="@GetTierImage(tier.Name)" />
                    <div class="tier-header">
                        <span class="tier-name">@tier.Name</span>
                        @if (isActive)
                        {
                            <span class="status-badge active">Current</span>
                        }
                        else if (isPending)
                        {
                            <span class="status-badge pending">Next Cycle</span>
                        }
                    </div>
                    <div class="tier-pricing">
                        <span class="tier-price-vc">@tier.Price VC/mo</span>
                        <span class="tier-price-usd">$@((tier.StripePriceCents / 100m).ToString("0.00"))/mo</span>
                    </div>
                    <p class="tier-desc">@tier.Description</p>
                    <ul class="tier-perks">
                        @foreach (var perk in GetPerks(tier.Name))
                        {
                            <li>@perk</li>
                        }
                    </ul>

                    @if (isActive || isPending)
                    {
                        @if (_activeSub.PendingType is not null && isPending)
                        {
                            <button class="v-btn tier-subscribe-btn" @onclick="OnClickCancelPending">
                                Undo Downgrade
                            </button>
                            <span class="upgrade-note">Keep @_activeSub.Type and remove the scheduled change to @_activeSub.PendingType.</span>
                        }

                        @if (isActive && _activeSub.StripeSubscriptionId is null)
                        {
                            <button class="v-btn tertiary tier-subscribe-btn" @onclick="() => OnClickStripeSubscribe(tier)">
                                Switch to Card Billing
                            </button>
                            <span class="upgrade-note">Keep this tier, move billing to Stripe, and apply your unused VC time as first-month credit.</span>
                        }
                    }
                    else if (isExpanded && tierAction == TierAction.Subscribe)
                    {
                        @* New subscription — show payment choice *@
                        <div class="payment-choice">
                            <button class="v-btn primary" @onclick="() => OnClickSubscribe(tier)">
                                Pay with VC (@tier.Price VC/mo)
                            </button>
                            @if (_globalAccount is not null && _globalAccount.BalanceValue < _dueNow)
                            {
                                <span class="balance-warning">Balance: @(_globalAccount.BalanceValue)VC (not enough)</span>
                            }
                            else if (_dueNow != tier.Price)
                            {
                                <span class="upgrade-note">Due now: @(_dueNow)VC (upgrade credit applied)</span>
                            }

                            <button class="v-btn tertiary" @onclick="() => OnClickStripeSubscribe(tier)">
                                Pay with Card ($@((tier.StripePriceCents / 100m).ToString("0.00"))/mo + @(tier.VcReward)VC reward!)
                            </button>

                            <button class="v-btn" @onclick="() => { _selectedTier = null; _errorSpan = null; StateHasChanged(); }">Nevermind</button>

                            @if (!string.IsNullOrWhiteSpace(_errorSpan))
                            {
                                <span class="v-text-red mt-2">@_errorSpan</span>
                            }
                        </div>
                    }
                    else if (isExpanded && tierAction == TierAction.Upgrade)
                    {
                        @* Upgrade — show prorated cost and confirm *@
                        <div class="payment-choice">
                            @if (_activeSub.StripeSubscriptionId is not null)
                            {
                                <button class="v-btn primary" @onclick="() => OnClickStripeChange(tier)">
                                    Confirm Upgrade ($@((tier.StripePriceCents / 100m).ToString("0.00"))/mo)
                                </button>
                                <span class="upgrade-note">Prorated charges will apply for the current period.</span>
                            }
                            else
                            {
                                <button class="v-btn primary" @onclick="() => OnClickSubscribe(tier)">
                                    Confirm Upgrade (@(_dueNow)VC due now)
                                </button>
                                @if (_globalAccount is not null && _globalAccount.BalanceValue < _dueNow)
                                {
                                    <span class="balance-warning">Balance: @(_globalAccount.BalanceValue)VC (not enough)</span>
                                }

                                <button class="v-btn tertiary" @onclick="() => OnClickStripeSubscribe(tier)">
                                    Switch to Card Billing ($@((tier.StripePriceCents / 100m).ToString("0.00"))/mo + @(tier.VcReward)VC reward!)
                                </button>
                                <span class="upgrade-note">Use Stripe billing, with unused VC time credited on your first Stripe month.</span>
                            }

                            <button class="v-btn" @onclick="() => { _selectedTier = null; _errorSpan = null; StateHasChanged(); }">Nevermind</button>

                            @if (!string.IsNullOrWhiteSpace(_errorSpan))
                            {
                                <span class="v-text-red mt-2">@_errorSpan</span>
                            }
                        </div>
                    }
                    else if (isExpanded && tierAction == TierAction.Downgrade)
                    {
                        @* Downgrade — takes effect next billing cycle *@
                        <div class="payment-choice">
                            @if (_activeSub.StripeSubscriptionId is not null)
                            {
                                <button class="v-btn primary" @onclick="() => OnClickStripeChange(tier)">
                                    Confirm Downgrade
                                </button>
                            }
                            else
                            {
                                <button class="v-btn primary" @onclick="() => OnClickSubscribe(tier)">
                                    Confirm Downgrade
                                </button>

                                <button class="v-btn tertiary" @onclick="() => OnClickStripeSubscribe(tier)">
                                    Switch to Card Billing ($@((tier.StripePriceCents / 100m).ToString("0.00"))/mo + @(tier.VcReward)VC reward!)
                                </button>
                            }
                            @if (_activeSub.StripeSubscriptionId is not null)
                            {
                                <span class="upgrade-note">Takes effect at your next billing cycle. No charge now.</span>
                            }
                            else
                            {
                                <span class="upgrade-note">VC downgrade takes effect next cycle. Stripe switch applies after checkout.</span>
                            }

                            <button class="v-btn" @onclick="() => { _selectedTier = null; _errorSpan = null; StateHasChanged(); }">Nevermind</button>

                            @if (!string.IsNullOrWhiteSpace(_errorSpan))
                            {
                                <span class="v-text-red mt-2">@_errorSpan</span>
                            }
                        </div>
                    }
                    else if (tierAction == TierAction.Subscribe)
                    {
                        <button class="v-btn primary tier-subscribe-btn" @onclick="async () => await OnSelectTier(tier)">Subscribe</button>
                    }
                    else if (tierAction == TierAction.Upgrade)
                    {
                        <button class="v-btn primary tier-subscribe-btn" @onclick="async () => await OnSelectTier(tier)">Upgrade</button>
                    }
                    else if (tierAction == TierAction.Downgrade)
                    {
                        <button class="v-btn tier-subscribe-btn" @onclick="async () => await OnSelectTier(tier)">Downgrade</button>
                    }
                </div>
            }
        </div>
    </div>

    @* Buy VC Credits *@
    <div class="editor-section">
        <div class="editor-section-title">
            <i class="bi bi-coin"></i>
            BUY VALOUR CREDITS
        </div>

        <div class="vc-grid">
            <div class="vc-card" @onclick="async () => await OnClickBuyCredits(500)">
                <img alt="500 VC" class="vc-img" src="_content/Valour.Client/media/subscriptions/credits_1.webp" />
                <span class="vc-amount">500 VC</span>
                <span class="vc-price">$5</span>
                <span class="vc-desc">$1 / 100VC</span>
            </div>
            <div class="vc-card" @onclick="async () => await OnClickBuyCredits(1000)">
                <img alt="1000 VC" class="vc-img" src="_content/Valour.Client/media/subscriptions/credits_2.webp" />
                <span class="vc-amount">1000 VC</span>
                <span class="vc-price">$9.50</span>
                <span class="vc-savings">Save 5%</span>
                <span class="vc-desc">$0.95 / 100VC</span>
            </div>
            <div class="vc-card" @onclick="async () => await OnClickBuyCredits(2000)">
                <img alt="2000 VC" class="vc-img" src="_content/Valour.Client/media/subscriptions/credits_3.webp" />
                <span class="vc-amount">2000 VC</span>
                <span class="vc-price">$18</span>
                <span class="vc-savings">Save 10%</span>
                <span class="vc-desc">$0.90 / 100VC</span>
            </div>
        </div>
    </div>
}

<div class="page-wrapper">
    <div class="top-confetti-container"></div>
</div>


@code {
    private enum SubPage { Main, Redirecting, StripeResult }
    private enum TierAction { Subscribe, Upgrade, Downgrade }

    private IJSObjectReference _jsModule;

    private SubPage _page = SubPage.Main;
    private UserSubscriptionType _selectedTier = null;
    private bool _confirmingCancel = false;

    private EcoAccount _globalAccount = null;
    private UserSubscription _activeSub = null;

    private string _errorSpan = null;
    private decimal _dueNow = 0;

    private string _redirectingMessage;
    private string _redirectingDetail;
    private string _stripeResultTitle;
    private string _stripeResultMessage;

    private static readonly List<UserSubscriptionType> _allTiers = new()
    {
        UserSubscriptionTypes.Stargazer,
        UserSubscriptionTypes.StargazerPlus,
        UserSubscriptionTypes.StargazerPro
    };

    protected override async Task OnInitializedAsync()
    {
        _globalAccount = await Client.EcoService.GetSelfGlobalAccountAsync();
        _activeSub = await Client.SubscriptionService.GetActiveSubscriptionAsync();

        // Check for Stripe return query params
        var uri = new Uri(NavManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var stripeResult = query["stripe"];
        if (stripeResult == "success")
        {
            _page = SubPage.StripeResult;
            _stripeResultTitle = "Thank you for your purchase!";
            _stripeResultMessage = "Your Valour Credits will be delivered to your account shortly.";
        }
        else if (stripeResult == "cancel")
        {
            _page = SubPage.StripeResult;
            _stripeResultTitle = "Purchase Cancelled";
            _stripeResultMessage = "Your purchase was cancelled. No charges were made.";
        }
        else if (stripeResult == "sub_success")
        {
            _page = SubPage.StripeResult;
            _stripeResultTitle = "Subscription Activated!";
            _stripeResultMessage = "Your subscription is now active. Thank you for supporting Valour!";
            _activeSub = await Client.SubscriptionService.GetActiveSubscriptionAsync();
        }
        else if (stripeResult == "sub_cancel")
        {
            _page = SubPage.StripeResult;
            _stripeResultTitle = "Subscription Setup Cancelled";
            _stripeResultMessage = "Your subscription setup was cancelled. No charges were made.";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _jsModule = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/Valour.Client/Components/Menus/Modals/Users/Edit/EditSubscriptionsComponent.razor.js");
        }
    }

    private void BackToMain()
    {
        _page = SubPage.Main;
        _selectedTier = null;
        _confirmingCancel = false;
        _errorSpan = null;
        StateHasChanged();
    }

    private async Task OnSelectTier(UserSubscriptionType tier)
    {
        _selectedTier = tier;
        _errorSpan = null;
        _dueNow = tier.Price;
        _dueNow = await Client.SubscriptionService.GetSubscriptionPriceAsync(tier.Name);
        StateHasChanged();
    }

    private async Task OnClickSubscribe(UserSubscriptionType tier)
    {
        _errorSpan = null;

        var result = await Client.SubscriptionService.SubscribeAsync(tier.Name);
        if (!result.Success)
        {
            _errorSpan = result.Message;
            StateHasChanged();
            return;
        }

        Client.Me.SubscriptionType = tier.Name;
        await _jsModule.InvokeVoidAsync("init");

        _activeSub = await Client.SubscriptionService.GetActiveSubscriptionAsync();
        _selectedTier = null;
        StateHasChanged();
    }

    private async Task OnClickStripeSubscribe(UserSubscriptionType tier)
    {
        var isVcToStripeMigration = _activeSub is not null
                                    && _activeSub.StripeSubscriptionId is null;

        _page = SubPage.Redirecting;
        _redirectingMessage = isVcToStripeMigration
            ? "Switching to card billing..."
            : "Setting up your subscription...";
        _redirectingDetail = isVcToStripeMigration
            ? $"You will be redirected to Stripe to switch from VC billing to the {tier.Name} card subscription. Any unused VC billing time will be credited on your first month."
            : $"You will be redirected to Stripe to set up your {tier.Name} subscription.";
        _errorSpan = null;
        StateHasChanged();

        var response = await Client.PrimaryNode.PostAsyncWithResponse<CheckoutResponse>($"api/stripe/subscribe/{tier.Name}");
        if (!response.Success || response.Data?.SessionUrl is null)
        {
            _errorSpan = response.Message ?? "Failed to create checkout session.";
            StateHasChanged();
            return;
        }

        NavManager.NavigateTo(response.Data.SessionUrl, forceLoad: true);
    }

    private async Task OnConfirmCancel()
    {
        _errorSpan = null;

        TaskResult result;
        if (_activeSub.StripeSubscriptionId is not null)
        {
            result = await Client.SubscriptionService.CancelStripeSubscriptionAsync();
        }
        else
        {
            result = await Client.SubscriptionService.UnsubscribeAsync();
        }

        if (!result.Success)
        {
            _errorSpan = result.Message;
            StateHasChanged();
            return;
        }

        _activeSub.Cancelled = true;
        _confirmingCancel = false;
        StateHasChanged();
    }

    private async Task OnClickReactivate()
    {
        _errorSpan = null;

        var type = UserSubscriptionTypes.TypeMap.GetValueOrDefault(_activeSub.Type);
        if (type is null) return;

        var result = await Client.SubscriptionService.SubscribeAsync(type.Name);
        if (!result.Success)
        {
            _errorSpan = result.Message;
            StateHasChanged();
            return;
        }

        _activeSub = await Client.SubscriptionService.GetActiveSubscriptionAsync();
        StateHasChanged();
    }

    private async Task OnClickStripeChange(UserSubscriptionType tier)
    {
        _errorSpan = null;

        var result = await Client.SubscriptionService.ChangeStripeSubscriptionAsync(tier.Name);
        if (!result.Success)
        {
            _errorSpan = result.Message;
            StateHasChanged();
            return;
        }

        _activeSub = await Client.SubscriptionService.GetActiveSubscriptionAsync();
        _selectedTier = null;

        if (_activeSub is not null)
            Client.Me.SubscriptionType = _activeSub.Type;

        StateHasChanged();
    }

    private async Task OnClickCancelPending()
    {
        _errorSpan = null;

        var result = await Client.SubscriptionService.CancelPendingChangeAsync();
        if (!result.Success)
        {
            _errorSpan = result.Message;
            StateHasChanged();
            return;
        }

        _activeSub = await Client.SubscriptionService.GetActiveSubscriptionAsync();
        StateHasChanged();
    }

    private TierAction GetTierAction(UserSubscriptionType tier)
    {
        if (_activeSub is null || _activeSub.Cancelled)
            return TierAction.Subscribe;

        if (!UserSubscriptionTypes.TypeMap.TryGetValue(_activeSub.Type, out var currentType))
            return TierAction.Subscribe;

        if (tier.Price > currentType.Price)
            return TierAction.Upgrade;

        return TierAction.Downgrade;
    }

    private async Task OnClickBuyCredits(int plan)
    {
        _page = SubPage.Redirecting;
        _redirectingMessage = "Purchasing Valour Credits...";
        _redirectingDetail = $"You will be redirected to Stripe to complete your purchase of {plan} Valour Credits.";
        _errorSpan = null;
        StateHasChanged();

        var response = await Client.PrimaryNode.PostAsyncWithResponse<CheckoutResponse>($"api/stripe/checkout/VC{plan}");
        if (!response.Success || response.Data?.SessionUrl is null)
        {
            _errorSpan = response.Message ?? "Failed to create checkout session.";
            StateHasChanged();
            return;
        }

        NavManager.NavigateTo(response.Data.SessionUrl, forceLoad: true);
    }

    private static string GetTierImage(string name) => name switch
    {
        "Stargazer" => "_content/Valour.Client/media/subscriptions/stargazer.webp",
        _ => "_content/Valour.Client/media/subscriptions/stargazer.webp"
    };

    private static string[] GetPerks(string name) => name switch
    {
        "Stargazer" => new[] { "Profile gradient borders", "Profile animations", "Stargazer badge", "50 MB upload limit" },
        "Stargazer Plus" => new[] { "All Stargazer perks", "Stargazer Plus badge (soon)", "100 MB upload limit" },
        "Stargazer Pro" => new[] { "All Stargazer Plus perks", "Stargazer Pro badge (soon)", "250 MB upload limit" },
        _ => Array.Empty<string>()
    };

    private string GetBannerStatusClass()
    {
        if (_activeSub.StripePaymentFailed) return "payment-failed";
        if (_activeSub.Cancelled) return "cancelled";
        return "active";
    }

    private string GetBadgeClass()
    {
        if (_activeSub.StripePaymentFailed) return "failed";
        if (_activeSub.Cancelled) return "cancelled";
        return "active";
    }

    private string GetStatusText()
    {
        if (_activeSub.StripePaymentFailed) return "Payment Failed";
        if (_activeSub.Cancelled) return "Cancelled";
        return "Active";
    }

    private string GetBillingText()
    {
        if (_activeSub.StripeSubscriptionId is not null)
            return "Billed monthly via Stripe";
        return "Billed monthly in VC";
    }

    private class CheckoutResponse
    {
        public string SessionUrl { get; set; }
    }
}
