@inject IJSRuntime JsRuntime
@inject ValourClient Client
@inject ThemeService ThemeService

@using System.Net.Http.Headers
@using Valour.Shared.Extensions
@using Valour.Client.Utility
@using Valour.Sdk.ModelLogic.QueryEngines
@using Valour.Shared.Models.Themes

@* Editing page *@
@if (_editingTheme is not null)
{
    <style>
        .pickr-button {
            position: absolute;
            right: 0px;
            transition: none 0s ease 0s;
            background-color: var(--pcr-color);
            height: 100%;
            width: 50px;
            border-radius: 0 2em 2em 0;
        }
    </style>
    
    <h4 class="title">Theme Editor</h4>
    <h5 class="subtitle">Build your own theme!</h5>
    <br />
    @if (_blobUrl is not null)
    {
        <div class="theme-img theme-img-@_editingTheme.Id" style="background-image: url(@_blobUrl)" onclick="document.getElementById('banner-upload').click()"></div>
    }
    else if (_editingTheme.HasCustomBanner)
    {
        if (_editingTheme.HasAnimatedBanner)
        {
            <style>
                .theme-img-@_editingTheme.Id:hover {
                    background-image: url(@_editingTheme.GetBannerUrl(ThemeBannerFormat.WebpAnimated)), url(@_editingTheme.GetBannerUrl(ThemeBannerFormat.Webp)), url(_content/Valour.Client/media/image-not-found.webp) !important;
                }
            </style>
        }
        
        <div class="theme-img theme-img-@_editingTheme.Id" style="background-image: url(@_editingTheme.GetBannerUrl(ThemeBannerFormat.Webp)), url(_content/Valour.Client/media/image-not-found.webp)" onclick="document.getElementById('banner-upload').click()"></div>
    }
    else
    {
        <div class="theme-img" style="text-align: center; background-color: @_editingTheme.MainColor1" onclick="document.getElementById('banner-upload').click()"> 
            <Victor Style="max-height: 80%; padding: 5px; padding-top: 10px;" Color="@_editingTheme.PastelCyan" />
        </div>
    }
    <br />
    <p>Suggested image size: 600x300px</p>
    
    
    <div style="display:none">
        <InputFile OnChange="@LoadFiles" accept=".png,.jpg,.jpeg,.gif,.webp" id="banner-upload"></InputFile>
    </div>
    
    <br />
    <br />
                                                                                                                                   
    <div class="form-group">
        <label>Name</label>
        <input class="form-control" @bind-value="@_editingTheme.Name" />
    </div>
    <br />
    <div class="form-group">
        <label>Description</label>
        <InputTextArea @bind-Value="@_editingTheme.Description" class="form-control">
        </InputTextArea>
    </div>
    <br />
    <div class="form-group">
        <label>Publishing</label>
        @if (_editingTheme.Published)
        {
            <button class="btn v-btn danger" @onclick="@(() => SetPublished(false))">
                Switch to Unpublished
            </button>
        }
        else
        {
            <button class="btn v-btn primary" @onclick="@(() => SetPublished(true))">
                Switch to Published
            </button>
        }
    </div>
    <br />
    <label>Color Swatch</label>
    <section class="color-section">
        <div class="color-pill">
            <span>Font Color</span>
            <ColorPickerComponent UseAsButton="true" ButtonClass="pickr-button" StartColor="@_editingTheme.FontColor" OnColorChange="@OnChangeFontColor"/>
        </div>
        <br/>
        <div class="color-pill">
            <span>Alt Font Color</span>
            <ColorPickerComponent UseAsButton="true" ButtonClass="pickr-button" StartColor="@_editingTheme.FontAltColor" OnColorChange="@OnChangeFontAltColor"/>
        </div>
        <br/>
        <div class="color-pill">
            <span>Link Color</span>
            <ColorPickerComponent UseAsButton="true" ButtonClass="pickr-button" StartColor="@_editingTheme.LinkColor" OnColorChange="@OnChangeLinkColor"/>
        </div>
        <br/>
        <div class="color-pill">
            <span>BG Color 1</span>
            <ColorPickerComponent UseAsButton="true" ButtonClass="pickr-button" StartColor="@_editingTheme.MainColor1" OnColorChange="@OnChangeMainColor1"/>
        </div>
        <br/>
        <div class="color-pill">
            <span>BG Color 2</span>
            <ColorPickerComponent UseAsButton="true" ButtonClass="pickr-button" StartColor="@_editingTheme.MainColor2" OnColorChange="@OnChangeMainColor2"/>
        </div>
        <br/>
        <div class="color-pill">
            <span>BG Color 3</span>
            <ColorPickerComponent UseAsButton="true" ButtonClass="pickr-button" StartColor="@_editingTheme.MainColor3" OnColorChange="@OnChangeMainColor3"/>
        </div>
        <br/>
        <div class="color-pill">
            <span>BG Color 4</span>
            <ColorPickerComponent UseAsButton="true" ButtonClass="pickr-button" StartColor="@_editingTheme.MainColor4" OnColorChange="@OnChangeMainColor4"/>
        </div>
        <br/>
        <div class="color-pill">
            <span>BG Color 5</span>
            <ColorPickerComponent UseAsButton="true" ButtonClass="pickr-button" StartColor="@_editingTheme.MainColor5" OnColorChange="@OnChangeMainColor5"/>
        </div>
        <br/>
        <div class="color-pill">
            <span>Tint Color</span>
            <ColorPickerComponent UseAsButton="true" ButtonClass="pickr-button" StartColor="@_editingTheme.TintColor" OnColorChange="@OnChangeTintColor"/>
        </div>
        <br/>

        <div class="color-pill">
            <span>Vibrant 1</span>
            <ColorPickerComponent UseAsButton="true" ButtonClass="pickr-button" StartColor="@_editingTheme.VibrantPurple" OnColorChange="@OnChangeVibrantColor1"/>
        </div>
        <br/>
        <div class="color-pill">
            <span>Vibrant 2</span>
            <ColorPickerComponent UseAsButton="true" ButtonClass="pickr-button" StartColor="@_editingTheme.VibrantBlue" OnColorChange="@OnChangeVibrantColor2"/>
        </div>
        <br/>
        <div class="color-pill">
            <span>Vibrant 3</span>
            <ColorPickerComponent UseAsButton="true" ButtonClass="pickr-button" StartColor="@_editingTheme.VibrantCyan" OnColorChange="@OnChangeVibrantColor3"/>
        </div>
        <br/>

        <div class="color-pill">
            <span>Pastel 1</span>
            <ColorPickerComponent UseAsButton="true" ButtonClass="pickr-button" StartColor="@_editingTheme.PastelCyan" OnColorChange="@OnChangePastelColor1"/>
        </div>
        <br/>
        <div class="color-pill">
            <span>Pastel 2</span>
            <ColorPickerComponent UseAsButton="true" ButtonClass="pickr-button" StartColor="@_editingTheme.PastelCyanPurple" OnColorChange="@OnChangePastelColor2"/>
        </div>
        <br/>
        <div class="color-pill">
            <span>Pastel 3</span>
            <ColorPickerComponent UseAsButton="true" ButtonClass="pickr-button" StartColor="@_editingTheme.PastelPurple" OnColorChange="@OnChangePastelColor3"/>
        </div>
        <br/>
        <div class="color-pill">
            <span>Pastel Danger</span>
            <ColorPickerComponent UseAsButton="true" ButtonClass="pickr-button" StartColor="@_editingTheme.PastelRed" OnColorChange="@OnChangePastelColorDanger"/>
        </div>
        <br/>
        <br/>
    </section>
    
    <div class="form-group">
        <label>Custom CSS</label>
        <InputTextArea @bind-Value="@_editingTheme.CustomCss" class="form-control">
        </InputTextArea>
        <button class="btn v-btn tertiary mt-2" @onclick="@OnCssChange">Apply CSS to Theme</button>
    </div>

    <br />

    <div class="form-group">
        <label>Theme Assets</label>
        <p class="hint" style="color: var(--font-alt-color); font-size: 0.85em;">Upload images or fonts. Images: use <code>var(--theme-asset-name)</code>. Fonts: use <code>font-family: "theme-font-name"</code>.</p>

        @if (_themeAssets?.Any() == true)
        {
            @foreach (var asset in _themeAssets)
            {
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    @if (asset.AssetType == "font")
                    {
                        <i class="bi bi-fonts" style="font-size: 2em; width: 48px; text-align: center;"></i>
                        <code>font-family: "theme-font-@asset.Name"</code>
                    }
                    else
                    {
                        <img src="@asset.Url" style="width: 48px; height: 48px; border-radius: 4px; object-fit: cover;" />
                        <code>var(--theme-asset-@asset.Name)</code>
                    }
                    <button class="btn v-btn danger" style="padding: 4px 8px; font-size: 0.8em;" @onclick="() => DeleteAssetAsync(asset)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            }
        }

        @if (_editingTheme.Id != 0)
        {
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                <input class="form-control" style="max-width: 200px;" @bind="_newAssetName" placeholder="Asset name (e.g. background)" />
                <button type="button" class="btn v-btn secondary" @onclick="@OpenAssetPickerAsync">Choose File</button>
                <span style="color: var(--font-alt-color); font-size: 0.85em;" title="@(_assetFileName ?? "No file selected")">@(_assetFileName ?? "No file selected")</span>
                <input id="@_assetUploadInputId" type="file" style="display: none;" accept=".png,.jpg,.jpeg,.webp,.gif,.woff2,.woff,.ttf,.otf" />
            </div>
            <button class="btn v-btn tertiary mt-2" style="width: fit-content;" disabled="@_uploadingAsset" @onclick="@UploadAssetAsync">
                @(_uploadingAsset ? "Uploading..." : "Upload Asset")
            </button>
            @if (!string.IsNullOrEmpty(_assetError))
            {
                <p style="color: var(--p-red); font-size: 0.85em; margin-top: 4px;">@_assetError</p>
            }
        }
        else
        {
            <p style="color: var(--font-alt-color); font-size: 0.85em;">Save the theme first to upload assets.</p>
        }
    </div>

    <br />
    
    <div class="button-row">
        <button class="btn v-btn large danger" @onclick="@CancelEdit">Cancel Changes</button>
        <button class="btn v-btn large tertiary" @onclick="@ConfirmChangesAsync">Confirm Changes</button>
    </div>
    
    <br />
    
    <ResultLabel Result="@_editingResult"/>
    
    <br />
}
@* Home page *@
else
{
    <h5>Current Theme:</h5>
    <br/>
    
    <div class="current-theme-section">
        <ThemeCard Theme="@ThemeComponent.Instance.CurrentTheme.ToMeta()" />
        <div class="create-theme-card" @onclick="@EnterEditorNewTheme">
            <div class="create-theme-content">
                <div class="create-theme-icon">
                    <i class="bi bi-plus-circle"></i>
                </div>
                <h4 class="create-theme-title">Create New Theme</h4>
                <p class="create-theme-description">Start building your own custom theme</p>
                <button class="create-theme-btn">
                    <i class="bi bi-palette"></i>
                    Get Started
                </button>
            </div>
        </div>
    </div>
    
    @if (ThemeComponent.Instance.CurrentTheme != Theme.Default)
    {
        <div class="form-group">
            <button class="btn v-btn tertiary mt-2" @onclick="@RevertThemeAsync">Revert to Default Theme</button>
        </div>
    }

    <br/>
    <br />
    
    <div class="theme-section">
        <h5>Popular Themes</h5>
        <LargeSearch Placeholder="Search themes..."
                     DebounceMs="300"
                     OnSearchChanged="@OnSearchChangeAsync"
                     OnSearchCleared="@OnSearchCleared" />
        <div class="carousel-section">
            <Carousel TItem="Valour.Sdk.Models.Themes.ThemeMeta"
                      @ref="_popularCarousel"
                      Items="@_popularThemesList"
                      Breakpoints="@_themeBreakpoints"
                      GapPx="16"
                      TransitionMs="300"
                      MinItemWidth="200"
                      MaxItemWidth="300"
                      ItemPadding="8"
                      IsLoading="@_isLoadingPopular"
                      EmptyMessage="No popular themes found">
                <ItemTemplate>
                    <ThemeCard Theme="@context" Editor="@this" />
                </ItemTemplate>
            </Carousel>
        </div>
    </div>
    
    <div class="theme-section">
        <h5>My Themes</h5>
        <div class="carousel-section">
            <Carousel TItem="Valour.Sdk.Models.Themes.ThemeMeta"
                      @ref="@_myCarousel"
                      Items="@_myThemes"
                      Breakpoints="@_themeBreakpoints"
                      GapPx="16"
                      TransitionMs="300"
                      MinItemWidth="200"
                      MaxItemWidth="300"
                      ItemPadding="8"
                      IsLoading="@_isLoadingMy"
                      EmptyMessage="You haven't created any themes yet">
                <ItemTemplate>
                    <ThemeCard Theme="@context" Editor="@this" />
                </ItemTemplate>
            </Carousel>
        </div>
    </div>

    <br />
    
}

@code {
    private Theme _backupTheme;
    private Theme _editingTheme;
    
    private Carousel<Valour.Sdk.Models.Themes.ThemeMeta> _popularCarousel;
    private Carousel<Valour.Sdk.Models.Themes.ThemeMeta> _myCarousel;

    private ThemeMetaQueryEngine _popularThemes;
    private int _popularThemeCount = 0;
    private List<Valour.Sdk.Models.Themes.ThemeMeta> _popularThemesList = new();
    private bool _isLoadingPopular = false;
    
    private List<Valour.Sdk.Models.Themes.ThemeMeta> _myThemes;
    private bool _isLoadingMy = false;
    
    private readonly List<Breakpoint> _themeBreakpoints = new()
    {
        new() { MinWidth = 0, Visible = 1 },      // Mobile: 1 item
        new() { MinWidth = 600, Visible = 2 },    // Tablet: 2 items
        new() { MinWidth = 900, Visible = 3 },    // Desktop: 3 items
        new() { MinWidth = 1200, Visible = 4 }    // Large: 4 items
    };

    private TaskResult<Theme>? _editingResult = null;

    private IBrowserFile _uploadedImage = null;
    private byte[] _uploadedImageBytes = null;

    private string _blobUrl;

    // Theme asset fields
    private List<ThemeAssetInfo> _themeAssets = new();
    private string _newAssetName;
    private string _assetFileName;
    private string _assetError;
    private bool _uploadingAsset;
    private readonly string _assetUploadInputId = $"theme-asset-upload-{System.Guid.NewGuid():N}";

    protected override async Task OnInitializedAsync()
    {
        await GetAllThemes();
        ThemeComponent.OnThemeChanged += ThemeChangedHandler;
        StateHasChanged();
    }
    
     
    private void ThemeChangedHandler()
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task LoadFiles(InputFileChangeEventArgs e)
    {
        _uploadedImage = e.File;
        
        using MemoryStream ms = new();
        var fileStream = e.File.OpenReadStream();
        await fileStream.CopyToAsync(ms);
        _uploadedImageBytes = ms.ToArray();
        
        _blobUrl = await JsRuntime.InvokeAsync<string>("createBlob", _uploadedImageBytes, e.File.ContentType);
        
        StateHasChanged();
    }
   


    private async Task OnSearchChangeAsync(string searchValue)
    {
        _isLoadingPopular = true;
        StateHasChanged();

        try
        {
            // Use proper ModelQueryEngine API with QueryOptions
            _popularThemes.SetFilter("search", searchValue, apply: true);

            // Reload themes with new filter
            _popularThemesList.Clear();
            _popularThemeCount = await _popularThemes.GetTotalCountAsync();

            // Load themes in batches
            int pageSize = 50;
            int currentPage = 0;

            while (true)
            {
                var page = await _popularThemes.GetPageAsync(currentPage, pageSize);
                if (page == null || page.Count == 0)
                    break;

                _popularThemesList.AddRange(page);

                if (page.Count < pageSize)
                    break;

                currentPage++;
            }
        }
        finally
        {
            _isLoadingPopular = false;
            StateHasChanged();

            if (_popularCarousel is not null)
                await _popularCarousel.Reset();
        }
    }

    private async Task OnSearchCleared()
    {
        _isLoadingPopular = true;
        StateHasChanged();

        try
        {
            // Clear the search filter
            _popularThemes.SetFilter("search", null, apply: true);

            // Reload themes without filter
            _popularThemesList.Clear();
            _popularThemeCount = await _popularThemes.GetTotalCountAsync();

            // Load themes in batches
            int pageSize = 50;
            int currentPage = 0;

            while (true)
            {
                var page = await _popularThemes.GetPageAsync(currentPage, pageSize);
                if (page == null || page.Count == 0)
                    break;

                _popularThemesList.AddRange(page);

                if (page.Count < pageSize)
                    break;

                currentPage++;
            }
        }
        finally
        {
            _isLoadingPopular = false;
            StateHasChanged();

            if (_popularCarousel is not null)
                await _popularCarousel.Reset();
        }
    }
    
    private void OnCssChange()
    {
        ThemeComponent.Instance.Refresh();
        Client.Logger.Log<EditThemeComponent>("Custom CSS updated.", "cyan");
    }
    
    private async Task SetPublished(bool published)
    {
        _editingTheme.Published = published;
        _myThemes = await ThemeService.GetMyThemes();
        StateHasChanged();
    }

    private async Task RevertThemeAsync()
    {
        await ThemeComponent.Instance.UninstallThemeAsync();
    }


    public async Task OpenEditorWithTheme(Theme theme)
    {
        _backupTheme = ThemeComponent.Instance.CurrentTheme;
        _editingTheme = theme;
        _assetFileName = null;
        _assetError = null;

        ThemeComponent.Instance.CurrentTheme = theme;
        ThemeComponent.Instance.Refresh();

        Client.Logger.Log<EditThemeComponent>($"Entering editor for theme: {theme.Name}", "cyan");

        if (theme.Id != 0)
            await LoadThemeAssetsAsync(theme.Id);

        StateHasChanged();
    }

    private void EnterEditorNewTheme()
    {
        _backupTheme = ThemeComponent.Instance.CurrentTheme;
        _assetFileName = null;
        _assetError = null;
        
        _editingTheme = new Theme(Client);
        ThemeComponent.Instance.CurrentTheme.CopyAllTo(_editingTheme);
        _editingTheme.Id = 0;
        _editingTheme.Name = "New Theme";
        _editingTheme.Description = "A new theme!";
        
        ThemeComponent.Instance.CurrentTheme = _editingTheme;
        
        Client.Logger.Log<EditThemeComponent>("Entering editor for new theme.", "cyan");
        
        StateHasChanged();
    }
    
    private void CancelEdit()
    {
        _editingTheme = null;
        _assetFileName = null;
        _assetError = null;
        Client.Logger.Log<EditThemeComponent>("Cancelled theme editing.", "cyan");
        
        ThemeComponent.Instance.CurrentTheme = _backupTheme;
        
        ThemeComponent.Instance.Refresh();
        
        StateHasChanged();
    }

    private async Task UploadBannerIfNeededAsync()
    {
        if (_uploadedImage is null)
            return;

        if (_uploadedImage.Size > 10240000)
            return;
        
        using var ms = new MemoryStream(_uploadedImageBytes);
        var streamContent = new StreamContent(ms);
        var content = new MultipartFormDataContent();
        streamContent.Headers.ContentType = new MediaTypeHeaderValue(_uploadedImage.ContentType);
        content.Add(streamContent, _uploadedImage.Name, _uploadedImage.Name);
        
        var result = await Client.PrimaryNode.PostMultipartDataWithResponse<string>($"upload/themeBanner/{_editingTheme.Id}", content);
        if (!result.Success)
        {
            Console.WriteLine("Failed to upload banner: " + result.Message);
        }

        _blobUrl = null;
    }

    private async Task ConfirmChangesAsync()
    {
        if (_editingTheme is null)
            return;

        // Prevent duplicate names for new themes only
        if (_editingTheme.Id == 0 && _myThemes != null && _myThemes.Any(t => t.Name == _editingTheme.Name))
        {
            _editingResult = new TaskResult<Theme>(false, "You already have a theme with that name.");
            StateHasChanged();
            return;
        }

        if (_editingTheme.Id == 0)
        {
            // New theme
            _editingResult = await _editingTheme.CreateAsync();
            await GetAllThemes();
            StateHasChanged();
        }
        else
        {
            // Existing theme
            _editingResult = await _editingTheme.UpdateAsync();
            await GetAllThemes();
            StateHasChanged();
        }

        if (!_editingResult.Value.Success)
        {
            Client.Logger.Log<EditThemeComponent>($"Failed to save theme: {_editingResult.Value.Message}", "red");
        }
        else
        {
            _editingTheme = _editingResult.Value.Data;
            
            await UploadBannerIfNeededAsync();
            
            _editingTheme = null;
            StateHasChanged();
        }
    }

    private Task OnChangeFontColor(string newColor)
    {
        _editingTheme.FontColor = newColor;
        ThemeComponent.Instance.Refresh();
        return Task.CompletedTask;
    }
    
    private Task OnChangeFontAltColor(string newColor)
    {
        _editingTheme.FontAltColor = newColor;
        ThemeComponent.Instance.Refresh();
        return Task.CompletedTask;
    }
    
    private Task OnChangeLinkColor(string newColor)
    {
        _editingTheme.LinkColor = newColor;
        ThemeComponent.Instance.Refresh();
        return Task.CompletedTask;
    }
    
    private Task OnChangeMainColor1(string newColor)
    {
        _editingTheme.MainColor1 = newColor;
        ThemeComponent.Instance.Refresh();
        return Task.CompletedTask;
    }
    
    private Task OnChangeMainColor2(string newColor)
    {
        _editingTheme.MainColor2 = newColor;
        ThemeComponent.Instance.Refresh();
        return Task.CompletedTask;
    }
    
    private Task OnChangeMainColor3(string newColor)
    {
        _editingTheme.MainColor3 = newColor;
        ThemeComponent.Instance.Refresh();
        return Task.CompletedTask;
    }
    
    private Task OnChangeMainColor4(string newColor)
    {
        _editingTheme.MainColor4 = newColor;
        ThemeComponent.Instance.Refresh();
        return Task.CompletedTask;
    }
    
    private Task OnChangeMainColor5(string newColor)
    {
        _editingTheme.MainColor5 = newColor;
        ThemeComponent.Instance.Refresh();
        return Task.CompletedTask;
    }
    
    private Task OnChangeTintColor(string newColor)
    {
        _editingTheme.TintColor = newColor;
        ThemeComponent.Instance.Refresh();
        return Task.CompletedTask;
    }
    
    private Task OnChangeVibrantColor1(string newColor)
    {
        _editingTheme.VibrantPurple = newColor;
        ThemeComponent.Instance.Refresh();
        return Task.CompletedTask;
    }
    
    private Task OnChangeVibrantColor2(string newColor)
    {
        _editingTheme.VibrantBlue = newColor;
        ThemeComponent.Instance.Refresh();
        return Task.CompletedTask;
    }
    
    private Task OnChangeVibrantColor3(string newColor)
    {
        _editingTheme.VibrantCyan = newColor;
        ThemeComponent.Instance.Refresh();
        return Task.CompletedTask;
    }
    
    private Task OnChangePastelColor1(string newColor)
    {
        _editingTheme.PastelCyan = newColor;
        ThemeComponent.Instance.Refresh();
        return Task.CompletedTask;
    }
    
    private Task OnChangePastelColor2(string newColor)
    {
        _editingTheme.PastelCyanPurple = newColor;
        ThemeComponent.Instance.Refresh();
        return Task.CompletedTask;
    }
    
    private Task OnChangePastelColor3(string newColor)
    {
        _editingTheme.PastelPurple = newColor;
        ThemeComponent.Instance.Refresh();
        return Task.CompletedTask;
    }
    
    private Task OnChangePastelColorDanger(string newColor)
    {
        _editingTheme.PastelRed = newColor;
        ThemeComponent.Instance.Refresh();
        return Task.CompletedTask;
    }

    private async Task OpenAssetPickerAsync()
    {
        try
        {
            var selectedName = await JsRuntime.InvokeAsync<string>("themeAssetPickFile", _assetUploadInputId);
            _assetFileName = string.IsNullOrWhiteSpace(selectedName) ? null : selectedName;
            if (!string.IsNullOrWhiteSpace(_assetFileName))
                _assetError = null;
        }
        catch (Microsoft.JSInterop.JSException)
        {
            _assetError = "File picker helper failed to load. Refresh the page and try again.";
        }

        StateHasChanged();
    }

    private async Task LoadThemeAssetsAsync(long themeId)
    {
        var response = await Client.PrimaryNode.GetJsonAsync<List<ThemeAssetInfo>>($"api/themes/{themeId}/assets");
        if (response.Success)
            _themeAssets = response.Data ?? new();
        else
            _themeAssets = new();
    }

    private async Task UploadAssetAsync()
    {
        _assetError = null;

        if (string.IsNullOrWhiteSpace(_newAssetName))
        {
            _assetError = "Please enter an asset name.";
            return;
        }

        ThemeAssetBrowserFile selectedFile;
        try
        {
            selectedFile = await JsRuntime.InvokeAsync<ThemeAssetBrowserFile>("themeAssetReadSelectedFile", _assetUploadInputId);
        }
        catch (Microsoft.JSInterop.JSException)
        {
            _assetError = "File picker helper failed to load. Refresh the page and try again.";
            return;
        }

        if (selectedFile is null || string.IsNullOrWhiteSpace(selectedFile.Base64))
        {
            _assetError = "Select a file first.";
            return;
        }

        if (selectedFile.Size > 20_971_520)
        {
            _assetError = "File is too large. Maximum size is 20MB.";
            return;
        }

        _uploadingAsset = true;
        StateHasChanged();

        try
        {
            byte[] bytes;
            try
            {
                bytes = Convert.FromBase64String(selectedFile.Base64);
            }
            catch
            {
                _assetError = "Failed to read the selected image file.";
                return;
            }

            var fileName = string.IsNullOrWhiteSpace(selectedFile.Name) ? "asset" : selectedFile.Name;
            var contentType = string.IsNullOrWhiteSpace(selectedFile.ContentType) ? "application/octet-stream" : selectedFile.ContentType;

            var content = new MultipartFormDataContent();
            var fileContent = new ByteArrayContent(bytes);
            try
            {
                fileContent.Headers.ContentType = new MediaTypeHeaderValue(contentType);
            }
            catch
            {
                fileContent.Headers.ContentType = new MediaTypeHeaderValue("application/octet-stream");
            }

            content.Add(fileContent, fileName, fileName);

            var result = await Client.PrimaryNode.PostMultipartDataWithResponse<ThemeAssetInfo>(
                $"upload/themeAsset/{_editingTheme.Id}?name={Uri.EscapeDataString(_newAssetName)}", content);

            if (!result.Success)
            {
                _assetError = result.Message ?? "Failed to upload asset.";
                return;
            }

            _newAssetName = null;
            _assetFileName = null;
            try
            {
                await JsRuntime.InvokeVoidAsync("themeAssetClearSelection", _assetUploadInputId);
            }
            catch (Microsoft.JSInterop.JSException)
            {
                // Safe to ignore; this is only for clearing local picker state.
            }
            await LoadThemeAssetsAsync(_editingTheme.Id);
        }
        finally
        {
            _uploadingAsset = false;
            StateHasChanged();
        }
    }

    private sealed class ThemeAssetBrowserFile
    {
        public string Name { get; set; }
        public string ContentType { get; set; }
        public long Size { get; set; }
        public string Base64 { get; set; }
    }

    private async Task DeleteAssetAsync(ThemeAssetInfo asset)
    {
        var result = await Client.PrimaryNode.DeleteAsync($"api/themes/{_editingTheme.Id}/assets/{asset.Id}");
        if (result.Success)
        {
            await LoadThemeAssetsAsync(_editingTheme.Id);
            StateHasChanged();
        }
    }

    private async Task GetAllThemes()
    {
        // Set loading states
        _isLoadingPopular = true;
        _isLoadingMy = true;
        StateHasChanged();
        
        try
        {
            _popularThemes = ThemeService.GetAvailableThemeReader(amount: 100);
            
            // Load all popular themes into a list
            _popularThemesList.Clear();
            _popularThemeCount = await _popularThemes.GetTotalCountAsync();
            
            // Load themes in batches
            int pageSize = 50;
            int currentPage = 0;
            
            while (true)
            {
                var page = await _popularThemes.GetPageAsync(currentPage, pageSize);
                if (page == null || page.Count == 0)
                    break;
                    
                _popularThemesList.AddRange(page);
                
                if (page.Count < pageSize)
                    break;
                    
                currentPage++;
            }
            
            _myThemes = await ThemeService.GetMyThemes();
        }
        finally
        {
            // Clear loading states
            _isLoadingPopular = false;
            _isLoadingMy = false;
            StateHasChanged();

            if (_popularCarousel is not null)
                await _popularCarousel.Reset();
            if (_myCarousel is not null)
                await _myCarousel.Reset();
        }
    }
    
    public void Dispose()
    {
        ThemeComponent.OnThemeChanged -= ThemeChangedHandler;
    }
}
