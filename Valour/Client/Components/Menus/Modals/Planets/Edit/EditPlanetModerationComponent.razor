@using Valour.Sdk.Models
@using Valour.Shared.Models.Staff
@using Valour.Sdk.ModelLogic
@inject ValourClient Client

<h5>Automod Triggers</h5>

<QueryTable
    @ref="_table"
    Columns="@_columns"
    Engine="@_engine"
    ShowSearch="true"
    Infinite="true"
    TableMinWidth="850"
    SearchPlaceholder="Search name..." />

<button class="v-btn mt-2" @onclick="OpenCreateModal">Add Trigger</button>
<ResultLabel Result="@_result" />

@code {
    [Parameter]
    public Planet Planet { get; set; }

    [CascadingParameter]
    public ModalRoot ModalRoot { get; set; }

    private QueryTable<AutomodTrigger> _table;
    private List<ColumnDefinition<AutomodTrigger>> _columns;
    private ModelQueryEngine<AutomodTrigger> _engine;
    private ITaskResult _result;

    protected override void OnInitialized()
    {
        Planet ??= WindowService.FocusedPlanet;
        _engine = Client.AutomodService.GetTriggerQueryEngine(Planet);

        _columns = new()
        {
            new()
            {
                Name = "Name",
                SortField = "name",
                Sortable = true,
                RenderFragment = row => @<span>@row.Row.Name</span>
            },
            new()
            {
                Name = "Type",
                SortField = "type",
                Sortable = true,
                RenderFragment = row => @<span>@GetTriggerTypeLabel(row.Row.Type)</span>
            },
            new()
            {
                Name = "Applies To",
                RenderFragment = row => @<span>@(row.Row.RunForEveryone ? "Everyone" : "Bypassable")</span>,
                Width = "140px"
            },
            new()
            {
                Name = "Trigger",
                RenderFragment = row => @<span>@GetTriggerSummary(row.Row)</span>
            },
            new()
            {
                Name = "Actions",
                RenderFragment = row => @<div class="button-row">
                        <button class="v-btn secondary" @onclick="(() => ViewTrigger(row.Row))">View</button>
                        <button class="v-btn danger" @onclick="(() => DeleteTrigger(row.Row))">Remove</button>
                    </div>,
                Width = "200px",
                TextAlign = "right"
            }
        };
    }

    private void OpenCreateModal()
    {
        var data = new AutomodTriggerModal.ModalParams
        {
            Planet = Planet,
            Trigger = null
        };
        ModalRoot.OpenModal<Moderation.AutomodTriggerModal>(data);
    }

    private void ViewTrigger(AutomodTrigger trigger)
    {
        var data = new AutomodTriggerModal.ModalParams
        {
            Planet = Planet,
            Trigger = trigger
        };
        ModalRoot.OpenModal<Moderation.AutomodTriggerModal>(data);
    }

    private async Task DeleteTrigger(AutomodTrigger trigger)
    {
        _result = await trigger.DeleteAsync();
        if (_result.Success && _table is not null)
            await _table.Requery();
    }

    private static string GetTriggerTypeLabel(AutomodTriggerType triggerType) =>
        triggerType switch
        {
            AutomodTriggerType.Blacklist => "Trigger Words",
            AutomodTriggerType.Spam => "Spam",
            AutomodTriggerType.Join => "Member Join",
            AutomodTriggerType.Command => "Command",
            _ => triggerType.ToString()
        };

    private static string GetTriggerSummary(AutomodTrigger trigger)
    {
        if (trigger.Type == AutomodTriggerType.Join)
            return "-";

        if (trigger.Type == AutomodTriggerType.Command)
            return "/" + (trigger.TriggerWords ?? string.Empty);

        if (trigger.Type != AutomodTriggerType.Spam)
            return trigger.TriggerWords ?? string.Empty;

        var messageThreshold = 5;
        var windowSeconds = 10;
        if (!string.IsNullOrWhiteSpace(trigger.TriggerWords))
        {
            var parts = trigger.TriggerWords.Split(',', StringSplitOptions.TrimEntries | StringSplitOptions.RemoveEmptyEntries);
            if (parts.Length >= 1 && int.TryParse(parts[0], out var parsedThreshold))
                messageThreshold = Math.Clamp(parsedThreshold, 2, 50);

            if (parts.Length >= 2 && int.TryParse(parts[1], out var parsedWindow))
                windowSeconds = Math.Clamp(parsedWindow, 1, 300);
        }

        return $"{messageThreshold} messages / {windowSeconds}s";
    }
}
