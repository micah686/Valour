@inherits Modal<AutomodActionModal.ModalParams>
@using Valour.Sdk.Models
@using Valour.Shared.Models.Staff
@using Valour.Shared.Models
@using Valour.Shared
@using Valour.Client.Utility
@using System
@inject ValourClient Client

<BasicModalLayout Title="@(_isNew ? "Add Action" : "Edit Action")" Icon="lightning-fill" MaxWidth="400px">
    <MainArea>
        <div class="form-group mt-2">
            <label>Type</label>
            <select class="form-control" @bind="_action.ActionType">
                @foreach (AutomodActionType t in Enum.GetValues<AutomodActionType>())
                {
                    <option value="@t">@GetActionTypeLabel(t)</option>
                }
            </select>
        </div>

        <div class="form-group mt-2">
            <label>Strikes Required</label>
            <InputNumber class="form-control" TValue="int" @bind-Value="_action.Strikes" />
        </div>
        <div class="form-group mt-2">
            <label><input type="checkbox" @bind="_action.UseGlobalStrikes" /> Use Global Strikes</label>
        </div>


        @if (ShowExpires)
        {
            <div class="form-group mt-2">
                <label>Duration Minutes (0 for permanent)</label>
                <InputNumber class="form-control" TValue="int" @bind-Value="_duration" />
            </div>
        }

        @if (ShowRole)
        {
            <div class="form-group mt-2">
                <label>Role</label>
                <CustomDropdown TItem="PlanetRole"
                                Items="Data.Planet.Roles"
                                SelectedItem="_selectedRole"
                                SelectedItemChanged="OnRoleChanged"
                                ItemTemplate="RoleFragments.RolePill"
                                SelectedItemTemplate="RoleFragments.RolePill"
                                Placeholder="Select Role" />
            </div>
        }

        @if (ShowMessage)
        {
            <div class="form-group mt-2">
                <label>Message</label>
                <textarea class="form-control" @bind="_action.Message"></textarea>
            </div>
        }

        @if (ShowResponseChannel)
        {
            <div class="form-group mt-2">
                <label>Response Channel</label>
                <CustomDropdown TItem="Channel"
                                Items="_chatChannels"
                                InitialItem="_selectedResponseChannel"
                                SelectedItemChanged="OnResponseChannelChanged"
                                ItemTemplate="ChannelFragments.ChannelPill"
                                Placeholder="Automatic (where triggered)" />
            </div>
            @if (_action.ResponseChannelId.HasValue)
            {
                <button class="v-btn mt-1" style="font-size:12px" @onclick="ClearResponseChannel">Reset to Automatic</button>
            }
        }

        <ResultLabel Result="@_result" />
    </MainArea>
    <ButtonArea>
        <div class="basic-modal-buttons">
            <button class="v-btn" @onclick="Close">Cancel</button>
            <button class="v-btn primary" @onclick="OnSave">Save</button>
        </div>
    </ButtonArea>
</BasicModalLayout>

@code {
    public class ModalParams
    {
        public Planet Planet { get; set; }
        public AutomodTrigger Trigger { get; set; }
        public AutomodAction? Action { get; set; }
        public Func<Task>? OnSaved { get; set; }
        public bool LocalOnly { get; set; } = false;
        public Func<AutomodAction, Task>? OnSavedAction { get; set; }
    }

    private AutomodAction _action;
    private bool _isNew;
    private int _duration;
    private PlanetRole? _selectedRole;
    private Channel? _selectedResponseChannel;
    private List<Channel> _chatChannels = new();
    private ITaskResult _result;


    protected override void OnInitialized()
    {
        _isNew = Data.Action is null;
        _chatChannels = Data.Planet.Channels
            .Where(c => c.ChannelType == ChannelTypeEnum.PlanetChat)
            .ToList();

        if (Data.Action is not null)
        {
            _action = Data.Action;
            _selectedRole = Data.Planet.Roles.FirstOrDefault(r => r.Id == (_action.RoleId ?? 0));
            _selectedResponseChannel = _action.ResponseChannelId.HasValue
                ? _chatChannels.FirstOrDefault(c => c.Id == _action.ResponseChannelId.Value)
                : null;
            _duration = _action.Expires.HasValue ?
                (int)Math.Ceiling((_action.Expires.Value - DateTime.UtcNow).TotalMinutes) : 0;
        }
        else
        {
            _action = new AutomodAction(Client)
            {
                PlanetId = Data.Planet.Id,
                TriggerId = Data.Trigger.Id,
                Message = string.Empty,
                Strikes = 1,
                UseGlobalStrikes = false
            };
            _selectedRole = null;
            _selectedResponseChannel = null;
        }
    }

    private bool ShowExpires => _action.ActionType == AutomodActionType.Ban;
    private bool ShowRole => _action.ActionType == AutomodActionType.AddRole || _action.ActionType == AutomodActionType.RemoveRole;
    private bool ShowMessage => _action.ActionType == AutomodActionType.Respond || _action.ActionType == AutomodActionType.Kick || _action.ActionType == AutomodActionType.Ban;
    private bool ShowResponseChannel => _action.ActionType == AutomodActionType.Respond;

    private static string GetActionTypeLabel(AutomodActionType actionType) => actionType switch
    {
        AutomodActionType.AddRole => "Add Role",
        AutomodActionType.RemoveRole => "Remove Role",
        AutomodActionType.DeleteMessage => "Delete Message",
        AutomodActionType.BlockMessage => "Block Message",
        _ => actionType.ToString()
    };

    private Task OnRoleChanged(PlanetRole role)
    {
        _selectedRole = role;
        return Task.CompletedTask;
    }

    private Task OnResponseChannelChanged(Channel channel)
    {
        _selectedResponseChannel = channel;
        _action.ResponseChannelId = channel?.Id;
        return Task.CompletedTask;
    }

    private void ClearResponseChannel()
    {
        _selectedResponseChannel = null;
        _action.ResponseChannelId = null;
    }

    private async Task OnSave()
    {
        if (ShowRole)
            _action.RoleId = _selectedRole?.Id;
        if (ShowExpires)
            _action.Expires = _duration > 0 ? DateTime.UtcNow.AddMinutes(_duration) : null;

        TaskResult<AutomodAction> res;
        if (_isNew)
        {
            if (Data.LocalOnly)
            {
                _action.Id = Guid.NewGuid();
                res = TaskResult<AutomodAction>.FromData(_action);
            }
            else
            {
                res = await Client.AutomodService.CreateActionAsync(_action);
            }
        }
        else
        {
            res = await _action.UpdateAsync();
        }

        _result = res;
        if (res.Success)
        {
            if (Data.LocalOnly)
            {
                if (Data.OnSavedAction is not null)
                    await Data.OnSavedAction.Invoke(_action);
            }
            else if (Data.OnSaved is not null)
            {
                await Data.OnSaved.Invoke();
            }
            Close();
        }
    }
}
