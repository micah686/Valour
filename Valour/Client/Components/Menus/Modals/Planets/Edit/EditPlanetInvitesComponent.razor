@inject ValourClient Client
@inject IJSRuntime JsRuntime
@inject NavigationManager NavManager

<div class="settings-container">
    <div class="editor-section">
        <h3 class="editor-section-title">
            <i class="bi bi-envelope-paper-heart"></i>
            Planet Invitations
        </h3>
        <p class="subtitle">Control how users join your planet</p>

        <div class="form-group">
            <label>
                <input type="checkbox" @oninput="OnCheckPublic" checked="@publicValue" />
                Invites Enabled
            </label>
            <p class="helper-text">
                @if (publicValue)
                {
                    <span>Users can join this planet via invite links.</span>
                }
                else
                {
                    <span style="color: var(--p-red);">Invites are disabled. All existing invite links will stop working until this is re-enabled.</span>
                }
            </p>
            <ResultLabel Result="@publicResult" />
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" @oninput="OnCheckDiscoverable" checked="@discoverableValue" />
                Discoverable
            </label>
            <p class="helper-text">Allow this planet to appear in discovery</p>
            <ResultLabel Result="@discoverableResult" />
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" @oninput="OnCheckNsfw" checked="@nsfwValue" />
                Not Safe For Work
            </label>
            <p class="helper-text">NSFW planets will not show on discovery</p>
            <ResultLabel Result="@nsfwResult" />
        </div>

        <CreateInviteLink Planet="Planet" />

        <h4 class="invite-list-title">Invite Links</h4>

        @if (!Planet.Invites.Any())
        {
            <div class="empty-state">
                <i class="bi bi-envelope"></i>
                <span>No invites yet</span>
            </div>
        }
        else
        {
            <div class="invite-list">
                @foreach (var invite in Planet.Invites)
                {
                    <div class="invite-card">
                        <div class="invite-info">
                            <span class="invite-code" title="@invite.Id">@invite.Id</span>
                            <div class="invite-meta">
                                <span>Created @invite.TimeCreated.ToLocalTime().ToShortDateString()</span>
                                <span class="separator">·</span>
                                <span>@(invite.TimeExpires?.ToLocalTime().ToShortDateString() ?? "Never expires")</span>
                            </div>
                        </div>
                        <div class="invite-actions">
                            <button class="v-btn small" title="Copy invite link" @onclick="() => CopyInviteLink(invite)">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                            <button class="v-btn small danger" title="Delete invite" @onclick="() => DeleteInvite(invite)">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public Planet Planet { get; set; }

    public bool publicValue;

    private ITaskResult publicResult;

    public bool discoverableValue;

    private ITaskResult discoverableResult;

    public bool nsfwValue;

    private ITaskResult nsfwResult;

    protected override async Task OnInitializedAsync()
    {
        publicValue = Planet.Public;
        discoverableValue = Planet.Discoverable;
        nsfwValue = Planet.Nsfw;
        Planet.Invites.Changed += OnPlanetInvitesChange;
        await Planet.LoadInvitesAsync();
    }

    public void Dispose()
    {
        Planet.Invites.Changed -= OnPlanetInvitesChange;
    }

    public void OnPlanetInvitesChange(IModelEvent<PlanetInvite> eventData)
    {
        InvokeAsync(StateHasChanged);
    }

    public async Task OnCheckPublic()
    {
        publicValue = !publicValue;

        Planet.Public = publicValue;
        publicResult = await Planet.UpdateAsync();

        if (!publicResult.Success)
        {
            publicValue = !Planet.Public;
        }

        StateHasChanged();
    }

    public async Task OnCheckDiscoverable()
    {
        discoverableValue = !discoverableValue;

        Planet.Discoverable = discoverableValue;
        discoverableResult = await Planet.UpdateAsync();

        if (!discoverableResult.Success)
        {
            discoverableValue = !Planet.Discoverable;
        }

        StateHasChanged();
    }

    public async Task OnCheckNsfw()
    {
        nsfwValue = !nsfwValue;

        Planet.Nsfw = nsfwValue;
        nsfwResult = await Planet.UpdateAsync();

        if (!nsfwResult.Success)
        {
            nsfwValue = !Planet.Nsfw;
        }

        StateHasChanged();
    }

    private async Task CopyInviteLink(PlanetInvite invite)
    {
        var link = NavManager.BaseUri.TrimEnd('/') + "/I/" + invite.Id;
        await JsRuntime.InvokeVoidAsync("clipboardCopy.copyText", link);
        ToastContainer.Instance.AddToast(new ToastData("Copied!", "Invite link copied to clipboard", ToastProgressState.Success));
    }

    private async Task DeleteInvite(PlanetInvite invite)
    {
        var result = await invite.DeleteAsync();
        if (result.Success)
        {
            ToastContainer.Instance.AddToast(new ToastData("Deleted", "Invite link has been deleted", ToastProgressState.Success));
        }
        else
        {
            ToastContainer.Instance.AddToast(new ToastData("Error", result.Message, ToastProgressState.Failure));
        }
    }

}