#!/bin/sh

# Install .NET 10 (preview)
curl -sSL https://dot.net/v1/dotnet-install.sh > dotnet-install.sh
chmod +x dotnet-install.sh
./dotnet-install.sh --channel 10.0 -InstallDir ./dotnet
export PATH="$PWD/dotnet:$PATH"
dotnet --version

# Build Valour Client.Blazor for Cloudflare Pages
dotnet workload restore Valour/Client.Blazor/Valour.Client.Blazor.csproj
dotnet workload install wasm-tools

# Cloudflare Pages expects the configured output directory to contain index.html at its root.
# dotnet publish for Blazor WASM places the site in <publish>/wwwroot, so flatten it into ./output.
PUBLISH_DIR=cf-publish
OUTPUT_DIR=output

rm -rf "$PUBLISH_DIR" "$OUTPUT_DIR"
dotnet publish Valour/Client.Blazor/Valour.Client.Blazor.csproj -c Release -o "$PUBLISH_DIR"
mkdir -p "$OUTPUT_DIR"
cp -R "$PUBLISH_DIR"/wwwroot/. "$OUTPUT_DIR"/

# Ensure referenced Razor Class Library assets exist at the expected static-web-assets path.
# In this project, the host page references `_content/Valour.Client/...` directly.
mkdir -p "$OUTPUT_DIR"/_content/Valour.Client
cp -R Valour/Client/wwwroot/. "$OUTPUT_DIR"/_content/Valour.Client/

# Explicit runtime API origin for static Pages deployments.
# Set VALOUR_API_ORIGIN to override, or set it to an empty string for same-origin.
API_ORIGIN="${VALOUR_API_ORIGIN-https://app.valour.gg/}"
printf 'window.valourRuntimeConfig = window.valourRuntimeConfig || {};\nwindow.valourRuntimeConfig.apiOrigin = "%s";\n' "$API_ORIGIN" > "$OUTPUT_DIR"/_content/Valour.Client/js/valour-runtime-config.js

# The Blazor host page currently lives in the shared Valour.Client project, not Client.Blazor/wwwroot.
# Ensure Cloudflare Pages has a root index.html to serve.
cp Valour/Client/wwwroot/index.html "$OUTPUT_DIR"/index.html

# SPA fallback for client-side routing (prevents refresh/deep-link 404s on Pages).
printf '/* /index.html 200\n' > "$OUTPUT_DIR/_redirects"
