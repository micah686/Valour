#!/bin/sh
set -eu

# Install .NET 10 (preview)
curl -sSL https://dot.net/v1/dotnet-install.sh > dotnet-install.sh
chmod +x dotnet-install.sh
./dotnet-install.sh --channel 10.0 -InstallDir ./dotnet
export PATH="$PWD/dotnet:$PATH"
dotnet --version

# Build Valour Client.Blazor for Cloudflare Pages
dotnet workload restore Valour/Client.Blazor/Valour.Client.Blazor.csproj
dotnet workload install wasm-tools

# Resolve a short commit hash for source + asset version placeholders.
SHORT_HASH="${CF_PAGES_COMMIT_SHA:-}"
if [ -z "$SHORT_HASH" ]; then
  SHORT_HASH="$(git rev-parse --short=8 HEAD 2>/dev/null || true)"
fi
if [ -z "$SHORT_HASH" ]; then
  SHORT_HASH="dev"
fi
SHORT_HASH="$(printf '%s' "$SHORT_HASH" | cut -c1-8)"
echo "Using SHORTHASH=${SHORT_HASH}"
export VALOUR_SHORT_HASH="$SHORT_HASH"

# Patch the shared version constant before compile so UI version text does not show $(SHORTHASH).
VERSION_FILE="Valour/Shared/Version.cs"
VERSION_FILE_BAK="$(mktemp)"
cp "$VERSION_FILE" "$VERSION_FILE_BAK"
trap 'cp "$VERSION_FILE_BAK" "$VERSION_FILE"; rm -f "$VERSION_FILE_BAK"' EXIT
perl -pi -e 's/\$\(SHORTHASH\)/$ENV{VALOUR_SHORT_HASH}/g' "$VERSION_FILE"

# Cloudflare Pages expects the configured output directory to contain index.html at its root.
# dotnet publish for Blazor WASM places the site in <publish>/wwwroot, so flatten it into ./output.
PUBLISH_DIR=cf-publish
OUTPUT_DIR=output

rm -rf "$PUBLISH_DIR" "$OUTPUT_DIR"
dotnet publish Valour/Client.Blazor/Valour.Client.Blazor.csproj -c Release -o "$PUBLISH_DIR"
mkdir -p "$OUTPUT_DIR"

# Blazor publish output layout can vary by SDK/version. Prefer <publish>/wwwroot,
# but fall back to the publish root when that is the web root.
PUBLISH_WEBROOT=""
if [ -d "$PUBLISH_DIR/wwwroot" ] && [ -e "$PUBLISH_DIR/wwwroot/_framework/blazor.webassembly.js" ]; then
  PUBLISH_WEBROOT="$PUBLISH_DIR/wwwroot"
elif [ -e "$PUBLISH_DIR/_framework/blazor.webassembly.js" ]; then
  PUBLISH_WEBROOT="$PUBLISH_DIR"
else
  echo "Could not locate Blazor publish web root in $PUBLISH_DIR"
  find "$PUBLISH_DIR" -maxdepth 3 -type f | sed -n '1,120p'
  exit 1
fi

cp -R "$PUBLISH_WEBROOT"/. "$OUTPUT_DIR"/

# Ensure referenced Razor Class Library assets exist at the expected static-web-assets path.
# In this project, the host page references `_content/Valour.Client/...` directly.
mkdir -p "$OUTPUT_DIR"/_content/Valour.Client
cp -R Valour/Client/wwwroot/. "$OUTPUT_DIR"/_content/Valour.Client/

# Explicit runtime API origin for static Pages deployments.
# Set VALOUR_API_ORIGIN to override, or set it to an empty string for same-origin.
API_ORIGIN="${VALOUR_API_ORIGIN-https://app.valour.gg/}"
echo "Using VALOUR_API_ORIGIN=${API_ORIGIN}"
printf 'window.valourRuntimeConfig = window.valourRuntimeConfig || {};\nwindow.valourRuntimeConfig.apiOrigin = "%s";\n' "$API_ORIGIN" > "$OUTPUT_DIR"/_content/Valour.Client/js/valour-runtime-config.js

# The Blazor host page currently lives in the shared Valour.Client project, not Client.Blazor/wwwroot.
# Ensure Cloudflare Pages has a root index.html to serve.
cp Valour/Client/wwwroot/index.html "$OUTPUT_DIR"/index.html

# Replace literal build placeholders used by the app for cache-busting/version display.
grep -RIl '\$(SHORTHASH)' "$OUTPUT_DIR" 2>/dev/null | while IFS= read -r file; do
  perl -pi -e 's/\$\(SHORTHASH\)/$ENV{VALOUR_SHORT_HASH}/g' "$file"
done || true

# Fail the build if the output is incomplete; otherwise Pages will serve index.html
# via the SPA fallback and browsers will report MIME type errors for missing assets.
for required in index.html _framework/blazor.webassembly.js manifest.json service-worker.js; do
  if [ ! -e "$OUTPUT_DIR/$required" ]; then
    echo "Missing required output file: $OUTPUT_DIR/$required"
    exit 1
  fi
done

# SPA fallback for client-side routing (prevents refresh/deep-link 404s on Pages).
printf '/* /index.html 200\n' > "$OUTPUT_DIR/_redirects"

# Prevent stale host page/runtime config when switching deploy env vars.
cat > "$OUTPUT_DIR/_headers" <<'EOF'
/index.html
  Cache-Control: no-store

/_content/Valour.Client/js/valour-runtime-config.js
  Cache-Control: no-store

/service-worker.js
  Cache-Control: no-cache
EOF
